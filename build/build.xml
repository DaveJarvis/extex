<!--
  ############################################################################
  # This is the Ant build file for ExTeX
  ############################################################################
  # Copyright (C) 2004-2006 The ExTeX Group
  #
  # This library is free software; you can redistribute it and/or modify it
  # under the terms of the GNU Lesser General Public License as published by
  # the Free Software Foundation; either version 2.1 of the License, or (at
  # your option) any later version.
  #
  # This library is distributed in the hope that it will be useful, but
  # WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser
  # General Public License for more details.
  #
  # You should have received a copy of the GNU Lesser General Public License
  # along with this library; if not, write to the Free Software Foundation,
  # Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
  #
  ######################################################################### -->

<project name="ExTeX" default="all" basedir=".">

  <description>
    ExTeX aims at the development of a high quality typesetting system.
    This development is massively based on the experiences with the
    typesetting system TeX. Despite of its age TeX can still be
    considered a very good choice. Nevertheless design decisions which
    where reasonable at the time of the writing of TeX can nowadays no
    longer be considered as state of the art.
  </description>

  <property name="tests.haltonfailure" value="no" />
  <property name="cases" value="**/*Test.java" />
  <property name="javac.deprecation" value="off" />
  <property name="extexjarfile" value="extex" />
  <property name="testsuitejarfile" value="testsuite" />
  <property name="src.tests" location="src/test" />
  <property name="classes" location="target/application/classes" />
  <property name="javadoc" location="target/javadoc" />
  <property name="deploy" location="deploy" />
  <property name="installer.dir" location="util/Installer" />
  <property name="target" location="target" />
  <property name="target.lib" location="target/lib" />
  <property name="target.tests" location="target/tests" />

  <path id="application.class.path">
    <fileset dir="..">
      <include name="ExTeX-*/lib/*.jar" />
    </fileset>
  </path>

  <path id="application.source.path">
    <dirset dir="..">
      <include name="ExTeX-core/src/java"/>
      <include name="ExTeX-Font/src/java"/>
      <include name="ExTeX-base/src/java"/>
      <include name="ExTeX-Scanner/src/java"/>
      <include name="ExTeX-Scanner32/src/java"/>
      <include name="ExTeX-Backend-dvi/src/java"/>
      <include name="ExTeX-Backend-dvix/src/java"/>
      <include name="ExTeX-Backend-pdfbox/src/java"/>
      <include name="ExTeX-Backend-ps/src/java"/>
      <include name="ExTeX-Backend-rtf/src/java"/>
      <include name="ExTeX-Unit-color/src/java"/>
      <include name="ExTeX-Unit-etex/src/java"/>
      <include name="ExTeX-Unit-extex/src/java"/>
      <include name="ExTeX-Unit-namespace/src/java"/>
      <include name="ExTeX-Unit-native/src/java"/>
      <include name="ExTeX-Unit-omega/src/java"/>
      <include name="ExTeX-Unit-pdftex/src/java"/>
      <include name="ExTeX-Unit-tex/src/java"/>
    </dirset>
  </path>

  <path id="develop.class.path">
    <fileset dir="develop/lib">
      <include name="*.jar" />
    </fileset>
  </path>
  <path id="test.class.path">
    <fileset dir="lib">
      <include name="*.jar" />
    </fileset>
    <fileset dir="develop/lib">
      <include name="*.jar" />
      <exclude name="ant.jar" />
    </fileset>
  </path>

  <macrodef name="iterate">
    <attribute name="target"/>
    <sequential>
      <subant target="@{target}">
        <fileset dir=".." includes="ExTeX-*/build.xml"/>
      </subant>
    </sequential>
  </macrodef>

  <!-- ==================================================================== -->
  <target name="all"
          description="Build nearly everything"
          depends="installer,javadoc,checkstyle,junitreport" />

  <!-- ==================================================================== -->
  <target name="clean"
          description="Remove unneccesary files and directories.">
    <iterate target="clean"/>
    <delete dir="${classes}" />
  </target>

  <!-- ==================================================================== -->
  <target name="javadoc"
          description="Create JavaDoc HTML pages.">
    <mkdir dir="${javadoc}" />
    <javadoc destdir="${javadoc}"
             sourcepathref="application.source.path"
             packagenames="org.extex.*"
             overview="${src}/overview.html"
             stylesheetfile="src/javadoc/stylesheet.css"
             author="true"
             version="true"
             use="true"
             splitindex="true"
             notree="false"
             nonavbar="false"
             noindex="false"
             nodeprecatedlist="false"
             nodeprecated="false">
      <classpath refid="application.class.path"/>
    </javadoc>
    <!--
    <copy todir="${javadoc}">
      <fileset dir="${application.source.path}">
        <include name="**/*.gif" />
        <include name="**/*.png" />
      </fileset>
    </copy>
    -->
  </target>
    
  <!-- ==================================================================== -->
  <target name="site"
          description="Build the site">
    <subant antfile="../www/build.xml"
            buildpath="../www"
            target="site"/>
  </target>

  <!-- ==================================================================== -->
  <target name="sub.compile"
          description="Compile the Java classes in all sub-projects">
    <iterate target="compile"/>
  </target>

  <!-- ==================================================================== -->
  <target name="sub.jar"
          description="Build the jars in all sub-projects">
    <iterate target="jar"/>
  </target>

  
  
  <!-- ==================================================================== -->
  <target name="compile.set" description="Compile the production Java files">
    <mkdir dir="${classes}" />
    <javac destdir="${classes}"
           debug="on"
           deprecation="${javac.deprecation}">
      <classpath refid="application.class.path" />
      <src path="../ExTeX-core/src/java"/>
      <src path="../ExTeX-Font/src/java"/>
      <src path="../ExTeX-base/src/java"/>
      <src path="../ExTeX-Scanner/src/java"/>
      <src path="../ExTeX-Scanner32/src/java"/>
      <src path="../ExTeX-Backend-dvi/src/java"/>
      <src path="../ExTeX-Backend-dvix/src/java"/>
      <src path="../ExTeX-Backend-pdfbox/src/java"/>
      <src path="../ExTeX-Backend-ps/src/java"/>
      <src path="../ExTeX-Backend-rtf/src/java"/>
      <src path="../ExTeX-Unit-color/src/java"/>
      <src path="../ExTeX-Unit-etex/src/java"/>
      <src path="../ExTeX-Unit-extex/src/java"/>
      <src path="../ExTeX-Unit-namespace/src/java"/>
      <src path="../ExTeX-Unit-native/src/java"/>
      <src path="../ExTeX-Unit-omega/src/java"/>
      <src path="../ExTeX-Unit-pdftex/src/java"/>
      <src path="../ExTeX-Unit-tex/src/java"/>
    </javac>
    <copy todir="${classes}">
      <fileset dir="src/java">
        <include name="**/*.properties" />
        <include name="**/*.xml" />
      </fileset>
      <fileset dir="src/resources">
        <include name="**/*.properties" />
        <include name="**/*.xml" />
      </fileset>
    </copy>
  </target>


  
  
  
  
  

  <!-- ==================================================================== -->
  <target name="build.html"
          description="Translate the build log into a HTML page">
    <xslt in="target/build.log"
          out="target/build.html"
          style="src/ant/log.xsl"
          />
  </target>


  
  
  
  <!-- ==================================================================== -->
  <!-- ==================================================================== -->
  <!-- ==================================================================== -->
  <!-- ==================================================================== -->

  <!-- ==================================================================== -->
  <target name="formats"
          description="Compile the format files">
    <ant dir="texmf" 
         target="formats" />
  </target>

  <!-- ==================================================================== -->
  <target name="compile.tests"
          description="Compile the Java files (with tests)">
    <mkdir dir="${classes}" />
    <javac srcdir="${src.tests}" destdir="${classes}" debug="on">
      <classpath refid="application.class.path" />
      <classpath refid="develop.class.path" />
      <classpath>
       <pathelement path="${classes}"/>
      </classpath>
    </javac>
    <copy todir="${classes}">
      <fileset dir="src">
        <include name="**/*.properties" />
        <include name="**/*.xml" />
        <include name="**/ExTeX-PL" />
      </fileset>
    </copy>
  </target>

  <!-- ==================================================================== -->
  <target name="jar"
          depends="compile.set"
          description="Create the ExTeX jar file containing all compiled classes
                       except test cases.">
    <mkdir dir="${target.lib}" />
    <!-- make a jar from the classes not matching magic testcase identifiers-->
    <jar jarfile="${target.lib}/${extexjarfile}.jar">
      <fileset dir="${classes}">
        <patternset>
          <exclude name="**/*Test.class" />
          <exclude name="**/*Tests.class" />
        </patternset>
      </fileset>
      <fileset dir=".">
        <patternset>
          <include name="LICENSE.txt" />
        </patternset>
      </fileset>
      <manifest>
        <attribute name="Built-By" value="${user.name}" />
        <attribute name="Main-Class" value="de.dante.extex.main.TeX" />
      </manifest>
    </jar>
  </target>

  <!-- ==================================================================== -->
  <target name="jar.tests"
          depends="compile.tests"
          description="Create test suite jar file">
    <mkdir dir="${target.lib}" />
    <jar jarfile="${target.lib}/${testsuitejarfile}.jar">
      <fileset dir="${classes}">
        <patternset>
          <include name="**/*Test.class" />
          <include name="**/AllTests.class" />
        </patternset>
      </fileset>
      <manifest>
        <attribute name="Built-By" value="${user.name}" />
      </manifest>
    </jar>
  </target>

  <!-- ==================================================================== -->
  <target name="testreport" depends="compile-develop,jar,checkstyle41-xml" 
          description="Run Checkstyle and create a HTML report">
    <java fork="true"
          classname="org.extex.checkstyle.ReportAddAuthor" 
          classpath="${target}/tmp">
      <classpath path="${target.lib}/${extexjarfile}.jar"/>
      <classpath refid="application.class.path" />
      <classpath refid="develop.class.path" />
      <arg value="${target}/checkstyle.xml"/>
      <arg value="${target}/checkstyle-author.xml"/>
    </java>
    <mkdir dir="${target}/html" />
    <xslt style="src/xslt/checkstyleauthorreport.xsl" 
          out="${target}/html/checkstyleauthorreport.html"
          in="${target}/checkstyle-author.xml" />
  </target>

  <!-- ==================================================================== -->
  <target name="compile-develop" 
          description="Compile the source in develop.">
        <mkdir dir="${target}/tmp" />
        <javac srcdir="develop/reports"
               destdir="${target}/tmp"
               debug="on">
          <classpath refid="application.class.path" />
          <classpath>
           <pathelement path="${classes}"/>
          </classpath>
        </javac>
    </target>
    
  <!-- ==================================================================== -->
  <target name="*** site ***" depends="compile-develop"
          description="">
    <java classname="org.extex.site.report.Summary"
          classpath="${target}/tmp"
    output="target/tests/index.xml">
      <arg value="-dir"/>
      <arg value="target/tests"/>
    </java>
    <xslt basedir="${target.tests}"
          destdir="${target}/www/reports/tests"
          extension=".html"
          style="develop/reports/junit.xsl">
      <classpath refid="develop.class.path" />
    </xslt>
  </target>

  <!-- ==================================================================== -->
  <target name="junitreport"
           depends="jar,jar.tests"
          description="Run JUnit tests and produce an HTML test report">
    <delete dir="${target.tests}" />
    <mkdir dir="${target.tests}" />
    <junit printsummary="on" haltonfailure="no">
      <jvmarg value="-Xms128m"/>
      <jvmarg value="-Xmx512m"/>
      <classpath>
        <pathelement path="${classes}" />
      </classpath>
      <classpath refid="test.class.path" />
      <formatter type="xml"/>
      <batchtest fork="yes" todir="${target.tests}">
        <fileset dir="${src.tests}">
          <include name="${cases}" />
        </fileset>
      </batchtest>
    </junit>
    <junitreport todir="${target.tests}">
      <fileset dir="${target.tests}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames"
              styledir="develop/reports"
         todir="${target}/www/reports/tests"/>
    </junitreport>
  </target>

  <!-- ==================================================================== -->
  <target name="checkstyle"
          description="Generates a report of violations of the coding conventions.">
    <checkstyle config="develop/eclipse/checkstyle.cfg"
                failureProperty="checkstyle.failure"
                failOnViolation="false">
      <formatter type="plain" tofile="${target}/checkstyle.txt" />
      <fileset dir="src" includes="**/*.java" />
    </checkstyle>
  </target>

  <!-- ==================================================================== -->
  <target name="checkstyle41"
    description="Generates a report of violations of the coding conventions using version 4.1.">
    <checkstyle config="develop/eclipse/extex_checkstyle.xml"
                failureProperty="checkstyle.failure"
          failOnViolation="false">
      <classpath>
        <pathelement location="develop/lib/checkstyle-all-4.1.jar" />
        <pathelement location="develop/lib/checkstyle-optional-4.1.jar" />
        </classpath>
      <formatter type="plain" tofile="${target}/checkstyle.txt" />
      <fileset dir="src" includes="**/*.java" />
    </checkstyle>
  </target>

  <!-- ==================================================================== -->
  <target name="checkstyle41-xml"
    description="Generates a report of violations of the coding conventions using version 4.1. (only in src/java)">
    <checkstyle config="develop/eclipse/extex_checkstyle.xml"
          failureProperty="checkstyle.failure"
          failOnViolation="false">
      <classpath>
        <pathelement location="develop/lib/checkstyle-all-4.1.jar" />
        <pathelement location="develop/lib/checkstyle-optional-4.1.jar" />
      </classpath>
      <formatter type="plain" tofile="${target}/checkstyle.txt" />
      <formatter type="xml" tofile="${target}/checkstyle.xml" />
      <fileset dir="src/java" includes="**/*.java" />
    </checkstyle>
  </target>

  <!-- ==================================================================== -->
  <target name="checkstyle-xml"
          description="Generates a report of violations of the coding conventions.">
    <checkstyle config="develop/eclipse/checkstyle.cfg"
                failureProperty="checkstyle.failure"
                failOnViolation="false">
      <formatter type="plain" tofile="${target}/checkstyle.txt" />
      <formatter type="xml" tofile="${target}/checkstyle.xml" />
      <fileset dir="src" includes="**/*.java" />
      <classpath refid="develop.class.path" />
    </checkstyle>
  </target>

  <!-- ==================================================================== -->
  <target name="installer"
          depends="jar,formats"
          description="Create a standalone installer for ExTeX.">
    <izpack input="${installer.dir}/install.xml"
            output="${target}/ExTeX-setup.jar"
            installerType="standard"
            basedir="${installer.dir}"
            izPackDir="${installer.dir}/IzPack/" />
  </target>

</project>
